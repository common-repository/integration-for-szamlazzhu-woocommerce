jQuery(document).ready(function(e){var a={settings_groups:["accounts","coupon","vatnumber","emails","email-notify","receipt","accounting","automation","vat-override","eusafa","advanced"],$additional_account_table:e(".wc-szamlazz-settings-inline-table-accounts"),$notes_table:e(".wc-szamlazz-settings-notes"),$automations_table:e(".wc-szamlazz-settings-automations"),$vat_overrides_table:e(".wc-szamlazz-settings-vat-overrides"),$eusafa_table:e(".wc-szamlazz-settings-eusafas"),$advanced_table:e(".wc-szamlazz-settings-advanced-options"),activation_nonce:"",init:function(){this.init_toggle_groups(),e("body").addClass("wc-szamlazz-settings-loaded"),this.activation_nonce=wc_szamlazz_params.nonces.settings,e("#woocommerce_wc_szamlazz_pro_email").keypress(this.submit_pro_on_enter),e("#wc_szamlazz_activate_pro").on("click",this.submit_activate_form),e("body").on("click","#wc_szamlazz_deactivate_pro",this.submit_deactivate_form),e("body").on("click","#wc_szamlazz_validate_pro",this.submit_validate_form),e(".wc-szamlazz-settings-submenu").on("click",".wc-szamlazz-settings-submenu-pro",function(){return e(this).WCBackboneModal({template:"wc-szamlazz-modal-pro-version"}),!1}),this.$additional_account_table.find("tfoot a").on("click",this.add_new_account_row),this.$additional_account_table.on("click","a.delete-row",this.delete_account_row),this.$additional_account_table.on("change","select",this.change_account_select_class),this.$additional_account_table.find("tbody tr").length<1&&this.add_new_account_row();var t=["notes","vat_overrides","eusafas","automations","advanced_options"];[this.$notes_table,this.$vat_overrides_table,this.$eusafa_table,this.$automations_table,this.$advanced_table].forEach(function(o,n){var i=t[n],s=i.slice(0,-1);s=s.replace("_","-"),o.on("change","select.condition",{group:i},a.change_x_condition),o.on("change","select.wc-szamlazz-settings-repeat-select",function(){a.reindex_x_rows(i)}),o.on("click",".add-row",{group:i},a.add_new_x_condition_row),o.on("click",".delete-row",{group:i},a.delete_x_condition_row),o.on("change","input.condition",{group:i},a.toggle_x_condition),o.on("click",".delete-"+s,{group:i},a.delete_x_row),e(".wc-szamlazz-settings-"+s+"-add a:not([data-disabled]").on("click",{group:i,table:o},a.add_new_x_row),o.find("ul.conditions[data-options]").each(function(){var a=e(this).data("options"),t=e(this);a.forEach(function(a){var o=e("#wc_szamlazz_"+i+"_condition_sample_row").html();(o=e(o)).find("select.condition").val(a.category),o.find("select.comparison").val(a.comparison),o.find("select.value").removeClass("selected"),o.find('select[data-condition="'+a.category+'"]').val(a.value).addClass("selected").attr("disabled",!1),t.append(o)})}),o.find(".wc-szamlazz-settings-"+s).length<1&&e(".wc-szamlazz-settings-"+s+"-add a:not([data-disabled]").trigger("click"),"advanced_options"==i&&o.find("input.condition").trigger("change"),a.reindex_x_rows(i)})},init_toggle_groups:function(){e.each(a.settings_groups,function(a,t){var o=e(".wc-szamlazz-toggle-group-"+t),n=e(".wc-szamlazz-toggle-group-"+t+"-item").parents("tr"),i=e(".wc-szamlazz-toggle-group-"+t+"-item-hide").parents("tr"),s=e(".wc-szamlazz-toggle-group-"+t+"-cell-hide"),l=e(".wc-szamlazz-toggle-group-"+t+"-cell-show"),c=o.is(":checked");"radio"==o.attr("type")&&(c="no"!=(o=o.parents("ul").find("input[type=radio]")).parents("ul").find("input[type=radio]:checked").val()),"emails"==t&&e(".wc-szamlazz-toggle-group-"+t+":checked").length&&(c=!0),c?(n.show(),i.hide(),s.hide(),l.show()):(n.hide(),i.show(),s.show(),l.hide()),o.change(function(a){a.preventDefault();var c=e(this).is(":checked");"radio"==o.attr("type")&&(c="no"!=o.parents("ul").find("input[type=radio]:checked").val()),"emails"==t&&e(".wc-szamlazz-toggle-group-"+t+":checked").length&&(c=!0),c?(n.show(),i.hide(),s.hide(),l.show()):(n.hide(),i.show(),s.show(),l.hide())})})},submit_pro_on_enter:function(a){if(13==a.which)return e("#wc_szamlazz_activate_pro").click(),!1},submit_activate_form:function(){var t=e("#woocommerce_wc_szamlazz_pro_key").val(),o=e(this),n=o.parent(),i=o.parents(".wc-szamlazz-pro-widget"),s={action:"wc_szamlazz_license_activate",key:t,nonce:a.activation_nonce};return n.block({message:null,overlayCSS:{background:"#f0f0f1 url("+wc_szamlazz_params.loading+") no-repeat center",backgroundSize:"16px 16px",opacity:.6}}),i.find(".wc-szamlazz-pro-widget-notice").hide(),e.post(ajaxurl,s,function(e){e.success?window.location.reload():(i.find(".wc-szamlazz-pro-widget-notice p").html(e.data.message),i.find(".wc-szamlazz-pro-widget-notice").show(),n.addClass("fail"),setTimeout(function(){n.removeClass("fail")},1e3),n.unblock())}),!1},submit_deactivate_form:function(){e(this);var t=e(".wc-szamlazz-modal-pro-version-content"),o={action:"wc_szamlazz_license_deactivate",nonce:a.activation_nonce};return t.block({message:null,overlayCSS:{background:"#ffffff url("+wc_szamlazz_params.loading+") no-repeat center",backgroundSize:"16px 16px",opacity:.6}}),t.find(".notice").hide(),e.post(ajaxurl,o,function(e){e.success?window.location.reload():(t.find(".notice p").html(e.data.message),t.find(".notice").show(),t.unblock())}),!1},submit_validate_form:function(){e(this);var t=e(".wc-szamlazz-modal-pro-version-content"),o={action:"wc_szamlazz_license_validate",nonce:a.activation_nonce};return t.block({message:null,overlayCSS:{background:"#ffffff url("+wc_szamlazz_params.loading+") no-repeat center",backgroundSize:"16px 16px",opacity:.6}}),t.find(".notice").hide(),e.post(ajaxurl,o,function(e){window.location.reload()}),!1},add_new_account_row:function(){var t=e("#wc_szamlazz_additional_accounts_sample_row").html();return a.$additional_account_table.find("tbody").append(t),a.reindex_account_rows(),!1},delete_account_row:function(){e(this).closest("tr").remove();return a.reindex_account_rows(),a.$additional_account_table.find("tbody tr").length<1&&a.add_new_account_row(),!1},reindex_account_rows:function(){e("#wc_szamlazz_additional_accounts_sample_row").html();return a.$additional_account_table.find("tbody tr").each(function(a){e(this).find("input, select").each(function(){var t=e(this).data("name");t=t.replace("X",a),e(this).attr("name",t)})}),!1},change_account_select_class:function(){0===this.selectedIndex?e(this).addClass("placeholder"):e(this).removeClass("placeholder")},change_x_condition:function(a){var t=e(this).val();e(this).parent().find("select.value").removeClass("selected").prop("disabled",!0),e(this).parent().find('select.value[data-condition="'+t+'"]').addClass("selected").prop("disabled",!1)},add_new_x_condition_row:function(t){var o=e("#wc_szamlazz_"+t.data.group+"_condition_sample_row").html();return e(this).closest("ul").append(o),a.reindex_x_rows(t.data.group),!1},delete_x_condition_row:function(t){return e(this).parent().remove(),a.reindex_x_rows(t.data.group),!1},reindex_x_rows:function(a){a=a.replace("_","-");return e(".wc-szamlazz-settings-"+a).find(".wc-szamlazz-settings-repeat-item").each(function(t){if(e(this).find("textarea, select, input").each(function(){var a=e(this).data("name");a=a.replace("X",t),e(this).attr("name",a)}),e(this).find("li").each(function(a){e(this).find("select").each(function(){var o=e(this).data("name");o=(o=o.replace("Y",a)).replace("X",t),e(this).attr("name",o)})}),e(this).find(".wc-szamlazz-settings-repeat-select").each(function(){var a=e(this).val(),t=e(this).find("option:selected").text();e(this).parent().find("label span").text(t),e(this).parent().find("label span").text(t),e(this).parent().find("label i").removeClass().addClass(a)}),"automations"==a){var o=e(this).find(".wc-szamlazz-settings-automation-document").val();e(this).find(".wc-szamlazz-settings-automation-option").show(),"paid"==o&&e(this).find(".wc-szamlazz-settings-automation-option:not(:first)").hide()}if("advanced-options"==a){e(this).find("inpput.condition").trigger("change");var n=e(this).find(".wc-szamlazz-settings-advanced-option-property").val();e(this).find(".wc-szamlazz-settings-advanced-option-option").hide(),e(this).find(".property-value").prop("disabled",!0),e(this).find(".wc-szamlazz-settings-advanced-option-option.option-"+n).show(),e(this).find(".wc-szamlazz-settings-advanced-option-option.option-"+n+" .property-value").prop("disabled",!1)}}),!1},add_new_x_row:function(t){var o=t.data.group,n=t.data.table,i=o.slice(0,-1),s=e("#wc_szamlazz_"+i+"_sample_row").html(),l=e("#wc_szamlazz_"+o+"_condition_sample_row").html();return(s=e(s)).find("ul").append(l),n.append(s),a.reindex_x_rows(o),!1},toggle_x_condition:function(t){var o=t.data.group,n=e(this).is(":checked"),i=e(this).closest(".wc-szamlazz-settings-repeat-item").find("ul.conditions");if(n){if(i.find("li").length<1){var s=e("#wc_szamlazz_"+o+"_condition_sample_row").html();i.append(s)}i.show()}else i.hide();if("notes"==o){var l=e(this).closest(".wc-szamlazz-settings-note").find(".wc-szamlazz-settings-note-if-append");n?l.show():l.hide()}if("automations"==o){var c=e(this).closest(".wc-szamlazz-settings-automation").find(".wc-szamlazz-settings-automation-if");n?c.show():c.hide()}a.reindex_x_rows(t.data.group)},delete_x_row:function(t){return e(this).closest(".wc-szamlazz-settings-repeat-item").remove(),a.reindex_x_rows(t.data.group),!1}},t={prefix:"wc_szamlazz_",prefix_id:"#wc_szamlazz_",prefix_class:".wc-szamlazz-",$metaboxContent:e("#wc_szamlazz_metabox .inside"),$disabledState:e(".wc-szamlazz-metabox-disabled"),$optionsContent:e(".wc-szamlazz-metabox-generate-options"),$autoMsg:e(".wc-szamlazz-metabox-auto-msg"),$generateContent:e(".wc-szamlazz-metabox-generate"),$optionsButton:e("#wc_szamlazz_invoice_options"),$generateButtonInvoice:e("#wc_szamlazz_invoice_generate"),$previewButton:e("#wc_szamlazz_invoice_preview"),$generateButtonReceipt:e("#wc_szamlazz_receipt_generate"),$receiptRowVoidNote:e(".wc-szamlazz-metabox-receipt-void-note"),$invoiceRow:e(".wc-szamlazz-metabox-invoices-invoice"),$receiptRow:e(".wc-szamlazz-metabox-invoices-receipt"),$proformRow:e(".wc-szamlazz-metabox-invoices-proform"),$deliveryRow:e(".wc-szamlazz-metabox-invoices-delivery"),$depositRow:e(".wc-szamlazz-metabox-invoices-deposit"),$voidedRow:e(".wc-szamlazz-metabox-invoices-void"),$correctedRow:e(".wc-szamlazz-metabox-invoices-corrected"),$voidedReceiptRow:e(".wc-szamlazz-metabox-invoices-void_receipt"),$completeRow:e(".wc-szamlazz-metabox-rows-data-complete"),$voidRow:e(".wc-szamlazz-metabox-rows-data-void"),$correctRow:e(".wc-szamlazz-metabox-rows-data-correct"),$messages:e(".wc-szamlazz-metabox-messages"),$reverseReceiptButton:e("#wc_szamlazz_reverse_receipt"),nonce:e(".wc-szamlazz-metabox-content").data("nonce"),order:e(".wc-szamlazz-metabox-content").data("order"),$uploadDocumentButton:e(".wc-szamlazz-invoice-upload"),is_receipt:!1,init:function(){this.$optionsButton.on("click",this.show_options),e(this.prefix_class+"invoice-toggle").on("click",this.toggle_invoice),this.$previewButton.on("click",this.show_preview),this.$generateButtonInvoice.on("click",this.generate_invoice),this.$generateButtonReceipt.on("click",this.generate_receipt),this.$completeRow.find("a").on("click",this.mark_completed),this.$voidRow.find("a").on("click",this.void_invoice),this.$correctRow.find("a").on("click",this.correct_invoice),this.$messages.find("a").on("click",this.hide_message),this.$reverseReceiptButton.on("click",this.reverse_receipt),this.$generateButtonReceipt.length&&(this.is_receipt=!0),this.$uploadDocumentButton.on("click",this.show_upload_modal),e("body").on("submit","#wc-szamlazz-modal-upload-form",this.upload_document),e("body").on("change","#wc_szamlazz_document_upload_file",this.on_upload_document_change)},loading_indicator:function(e,a){t.hide_message(),e.block({message:null,overlayCSS:{background:a+" url("+wc_szamlazz_params.loading+") no-repeat center",backgroundSize:"16px 16px",opacity:.6}})},show_options:function(){return t.$optionsButton.toggleClass("active"),t.$optionsContent.slideToggle(),!1},toggle_invoice:function(){var a="";if(e(this).hasClass("off")&&!(a=prompt("Számlakészítés kikapcsolása. Mi az indok?","Ehhez a rendeléshez nem kell számla.")))return!1;var o={action:t.prefix+"toggle_invoice",nonce:t.nonce,order:t.order,note:a};return t.loading_indicator(t.$metaboxContent,"#fff"),e.post(ajaxurl,o,function(e){t.$disabledState.find("span").text(a),t.$metaboxContent.unblock(),"off"==e.data.state?(t.$disabledState.slideDown(),t.$optionsContent.slideUp(),t.$autoMsg.slideUp(),t.$generateContent.slideUp(),t.$voidedRow.slideUp()):(t.$disabledState.slideUp(),t.$autoMsg.slideDown(),t.$generateContent.slideDown())}),!1},show_document_response:function(a){"invoice"==a.data.type&&(t.$autoMsg.slideUp(),t.$generateContent.slideUp(),t.$voidedRow.slideUp(),t.$invoiceRow.find("strong").text(a.data.name),t.$invoiceRow.find("a").attr("href",a.data.link),t.$invoiceRow.slideDown(),t.$completeRow.slideDown(),t.$voidRow.slideDown(),a.data.completed&&(t.$completeRow.find("a").addClass("completed"),t.$completeRow.find("a").text(a.data.completed)),a.data.delivery&&(t.$deliveryRow.find("strong").text(a.data.delivery.name),t.$deliveryRow.find("a").attr("href",a.data.delivery.link),t.$deliveryRow.slideDown())),"proform"==a.data.type&&(e("#wc_szamlazz_invoice_normal").prop("checked",!0),t.$optionsContent.slideUp(),t.$proformRow.find("strong").text(a.data.name),t.$proformRow.find("a").attr("href",a.data.link),t.$proformRow.slideDown(),t.$voidedRow.slideUp()),"delivery"==a.data.type&&(e("#wc_szamlazz_invoice_normal").prop("checked",!0),t.$optionsContent.slideUp(),t.$deliveryRow.find("strong").text(a.data.name),t.$deliveryRow.find("a").attr("href",a.data.link),t.$deliveryRow.slideDown(),t.$voidedRow.slideUp()),"deposit"==a.data.type&&(e("#wc_szamlazz_invoice_normal").prop("checked",!0),t.$optionsContent.slideUp(),t.$depositRow.find("strong").text(a.data.name),t.$depositRow.find("a").attr("href",a.data.link),t.$depositRow.slideDown(),t.$voidedRow.slideUp())},generate_invoice:function(){var a=e(this),o="invoice";if(1!=confirm(a.data("question")))return!1;var n=e("#wc_szamlazz_invoice_account").val(),i=e("#wc_szamlazz_invoice_lang").val(),s=e("#wc_szamlazz_invoice_doc_type").val(),l=e("#wc_szamlazz_invoice_note").val(),c=e("#wc_szamlazz_invoice_deadline").val(),d=e("#wc_szamlazz_invoice_completed").val(),r=e("#wc_szamlazz_invoice_proform").is(":checked"),m=e("#wc_szamlazz_invoice_delivery").is(":checked"),z=e("#wc_szamlazz_invoice_deposit").is(":checked"),_=e("#wc_szamlazz_mark_as_paid").is(":checked");r&&(o="proform"),m&&(o="delivery"),z&&(o="deposit");var u={action:t.prefix+"generate_invoice",nonce:t.nonce,order:t.order,account:n,lang:i,doc_type:s,note:l,deadline:c,completed:d,type:o,paid:_};return t.loading_indicator(t.$metaboxContent,"#fff"),e.post(ajaxurl,u,function(e){t.$metaboxContent.unblock(),t.show_messages(e),e.data.error||t.show_document_response(e)}),!1},generate_receipt:function(){var a=e(this);if(1!=confirm(a.data("question")))return!1;var o={action:t.prefix+"generate_receipt",nonce:t.nonce,order:t.order};return t.loading_indicator(t.$metaboxContent,"#fff"),e.post(ajaxurl,o,function(e){t.$metaboxContent.unblock(),t.show_messages(e),e.data.error||(t.$autoMsg.slideUp(),t.$generateContent.slideUp(),t.$receiptRow.find("strong").text(e.data.name),t.$receiptRow.find("a").attr("href",e.data.link),t.$receiptRow.slideDown(),t.$voidRow.slideDown())}),!1},mark_completed_timeout:!1,mark_completed:function(){var a=e(this);if(a.hasClass("completed"))return!1;if(a.hasClass("confirm")){clearTimeout(t.mark_completed_timeout),t.loading_indicator(t.$completeRow,"#fff");var o={action:t.prefix+"mark_completed",nonce:t.nonce,order:t.order};e.post(ajaxurl,o,function(e){t.$completeRow.unblock(),t.show_messages(e),e.data.error?a.fadeOut(function(){a.text(a.data("trigger-value")),a.removeClass("confirm"),a.fadeIn()}):a.fadeOut(function(){a.text(e.data.completed),a.addClass("completed"),a.fadeIn(),a.removeClass("confirm")})})}else t.mark_completed_timeout=setTimeout(function(){a.fadeOut(function(){a.text(a.data("trigger-value")),a.fadeIn(),a.removeClass("confirm")})},5e3),a.addClass("confirm"),a.fadeOut(function(){a.text("Biztos?"),a.fadeIn()});return!1},void_invoice_timeout:!1,void_invoice:function(){var a=e(this);if(a.hasClass("confirm")){clearTimeout(t.void_invoice_timeout),t.loading_indicator(t.$voidRow,"#fff");var o=t.is_receipt?"void_receipt":"void_invoice",n={action:t.prefix+o,nonce:t.nonce,order:t.order};e.post(ajaxurl,n,function(e){t.$voidRow.unblock(),t.show_messages(e),e.data.error||(t.$invoiceRow.slideUp(),t.$completeRow.slideUp(),t.$deliveryRow.slideUp(),t.$depositRow.slideUp(),t.$receiptRow.slideUp(),t.$correctRow.slideUp(),t.$proformRow.slideUp(),t.$voidRow.slideUp(function(){a.text(e.data.completed),a.removeClass("confirm")}),"yes"==wc_szamlazz_params.delete_proform_too&&t.$proformRow.slideUp(),t.$generateContent.slideDown(),t.$autoMsg.slideDown(),t.is_receipt?(t.$voidedReceiptRow.find("strong").text(e.data.name),t.$voidedReceiptRow.find("a").attr("href",e.data.link),t.$voidedReceiptRow.slideDown(),t.$receiptRowVoidNote.slideDown(),t.$generateContent.slideUp()):e.data.name&&(t.$voidedRow.find("strong").text(e.data.name),t.$voidedRow.find("a").attr("href",e.data.link),t.$voidedRow.slideDown())),a.fadeOut(function(){a.text(a.data("trigger-value")),a.fadeIn(),a.removeClass("confirm")})})}else t.void_invoice_timeout=setTimeout(function(){a.fadeOut(function(){a.text(a.data("trigger-value")),a.fadeIn(),a.removeClass("confirm")})},5e3),a.addClass("confirm"),a.fadeOut(function(){a.text(a.data("question")),a.fadeIn()});return!1},correct_invoice_timeout:!1,correct_invoice:function(){var a=e(this);if(a.hasClass("confirm")){clearTimeout(t.correct_invoice_timeout),t.loading_indicator(t.$correctRow,"#fff");t.is_receipt;var o=e("#wc_szamlazz_invoice_account").val(),n=e("#wc_szamlazz_invoice_lang").val(),i=e("#wc_szamlazz_invoice_note").val(),s=e("#wc_szamlazz_invoice_deadline").val(),l=e("#wc_szamlazz_invoice_completed").val(),c={action:t.prefix+"generate_invoice",nonce:t.nonce,order:t.order,account:o,lang:n,note:i,deadline:s,completed:l,type:"corrected"};e.post(ajaxurl,c,function(e){t.$correctRow.unblock(),t.show_messages(e),e.data.error||(t.$voidRow.slideUp(function(){a.text(e.data.completed),a.removeClass("confirm")}),t.$correctRow.slideUp(function(){a.text(e.data.completed),a.removeClass("confirm")}),t.$correctedRow.find("strong").text(e.data.name),t.$correctedRow.find("a").attr("href",e.data.link),t.$correctedRow.slideDown()),a.fadeOut(function(){a.text(a.data("trigger-value")),a.fadeIn(),a.removeClass("confirm")})})}else t.void_invoice_timeout=setTimeout(function(){a.fadeOut(function(){a.text(a.data("trigger-value")),a.fadeIn(),a.removeClass("confirm")})},5e3),a.addClass("confirm"),a.fadeOut(function(){a.text(a.data("question")),a.fadeIn()});return!1},show_messages:function(a){a.data.messages&&a.data.messages.length>0&&(this.$messages.removeClass("wc-szamlazz-metabox-messages-success"),this.$messages.removeClass("wc-szamlazz-metabox-messages-error"),a.data.error?this.$messages.addClass("wc-szamlazz-metabox-messages-error"):this.$messages.addClass("wc-szamlazz-metabox-messages-success"),$ul=this.$messages.find("ul"),$ul.html(""),e.each(a.data.messages,function(a,t){var o=e("<li>");o.append(t),$ul.append(o)}),this.$messages.slideDown())},hide_message:function(){return t.$messages.slideUp(),!1},reverse_receipt:function(){var a={action:t.prefix+"reverse_receipt",nonce:t.nonce,order:t.order};t.loading_indicator(t.$metaboxContent,"#fff"),e.post(ajaxurl,a,function(e){window.location.reload()})},show_preview:function(){var a=e("#wc_szamlazz_invoice_note").val(),t=e("#wc_szamlazz_invoice_deadline").val(),o=e("#wc_szamlazz_invoice_completed").val(),n=e("#wc_szamlazz_invoice_account").val(),i=e(this).data("url"),s={note:a,deadline:t,completed:o,account:n};return i+="&"+e.param(s),e(this).attr("href",i),!0},show_upload_modal:function(){return e(this).WCBackboneModal({template:"wc-szamlazz-modal-upload",variable:{order_id:t.order}}),e("#wc_szamlazz_mark_paid_date").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0,maxDate:0}),!1},on_upload_document_change:function(a){var t=a.target;if(t.files.length>0){var o=t.files[0].name.split(".").slice(0,-1).join(".");e(".wc-szamlazz-modal-upload #wc_szamlazz_document_upload_name").val(o)}},upload_document:function(a){a.preventDefault();var n=e(this),i=window.FormData?new FormData(n[0]):null,s=(null!==i||n.serialize(),e(".wc-szamlazz-modal-upload #wc_szamlazz_document_upload_name").val()),l=e(".wc-szamlazz-modal-upload #wc_szamlazz_document_upload_file").val(),c=!0;return i.append("action","wc_szamlazz_upload_document"),i.append("nonce",t.nonce),i.append("order",t.order),s||(c=!1,e("#wc_szamlazz_document_upload_name").parent().addClass("validate"),setTimeout(function(){e("#wc_szamlazz_document_upload_name").parent().removeClass("validate")},1e3)),l||(c=!1,e("#wc_szamlazz_document_upload_file").parent().addClass("validate"),setTimeout(function(){e("#wc_szamlazz_document_upload_file").parent().removeClass("validate")},1e3)),c&&(t.loading_indicator(e(".wc-szamlazz-modal-upload-form"),"#fff"),e.ajax({type:"POST",url:ajaxurl,contentType:!1,processData:!1,dataType:"JSON",status:200,data:i,success:function(a){console.log(a),o.show_messages(a,"uploader-results"),e(".wc-szamlazz-modal-upload-form").unblock(),t.show_document_response(a),e(".modal-close-link").trigger("click")}})),!1}};e(".wc-szamlazz-notice .wc-szamlazz-hide-notice").on("click",function(a){a.preventDefault();var t=e(this).closest(".wc-szamlazz-notice");if(e(t).find(".wc-szamlazz-wait").remove(),e(t).append('<div class="wc-szamlazz-wait"></div>'),e(".wc-szamlazz-notice.updating").length>0){var o=e(this);return setTimeout(function(){o.triggerHandler("click")},100),!1}e(t).addClass("updating"),e.post(ajaxurl,{action:"wc_szamlazz_hide_notice",security:e(this).data("nonce"),notice:e(this).data("notice"),remind:e(this).hasClass("remind-later")?"yes":"no"},function(){e(t).removeClass("updating"),e(t).fadeOut(100)})});var o={init:function(){e("#wpbody").on("click","#doaction",function(){if("wc_szamlazz_bulk_grouped_generate"==e("#bulk-action-selector-top").val())return o.show_grouped_modal(),!1}),e("#wpbody").on("click","#doaction2",function(){if("wc_szamlazz_bulk_grouped_generate"==e("#bulk-action-selector-bottom").val())return o.show_grouped_modal(),!1}),e(document).on("click","#generate_grouped_invoice",this.generate_grouped_invoices);var a=!1;e(window).keydown(function(e){77==e.which&&(a=!0)}).keyup(function(e){77==e.which&&(a=!1)}),e("#wpbody").on("click","a.wc-szamlazz-mark-paid-button",function(){if(e(this).hasClass("paid"))return!1;var o=e(this).data("order"),n=e(this).data("nonce"),i=e.datepicker.formatDate("yy-mm-dd",new Date);if(a){e(this).addClass("paid"),e(this).tipTip({content:"Fizetve: "+i}),e("#tiptip_content").text("Fizetve: "+i);var s={action:t.prefix+"mark_completed",nonce:n,order:o};e.post(ajaxurl,s,function(e){})}else e(this).WCBackboneModal({template:"wc-szamlazz-modal-mark-paid",variable:{order_id:o}}),e("#wc_szamlazz_mark_paid_date").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0,maxDate:0});return!1}),e("body").on("click","#wc_szamlazz_mark_paid",function(){var a=e(this).data("order"),o=e(this).data("nonce"),n=e("#wc_szamlazz_mark_paid_date").val(),i={action:t.prefix+"mark_completed",nonce:o,order:a,date:n};return e('a.wc-szamlazz-mark-paid-button[data-order="'+a+'"]').addClass("paid"),e('a.wc-szamlazz-mark-paid-button[data-order="'+a+'"]').tipTip({content:"Fizetve: "+n}),e.post(ajaxurl,i,function(e){}),e(".modal-close-link").trigger("click"),!1})},show_grouped_modal:function(){var a=jQuery("#the-list input[name='id[]']:checked"),t=[],o=e("<ul/>");return o.addClass("wc-szamlazz-modal-grouped-generate-list"),e(a).each(function(n){var i=e(a[n]).val(),s=e(a[n]).parents(".type-shop_order").find("a.order-view").text();o.append('<li><label><input type="radio" name="main_order_id" value="'+i+'"> '+s+"</label></li>"),t.push(i)}),0===a.length&&(t=!1),e(this).WCBackboneModal({template:"wc-szamlazz-modal-grouped-generate",variable:{orders:o.prop("outerHTML"),orderIds:t}}),!1},generate_grouped_invoices:function(){var a=e(this).data("orders"),n=e(this).data("nonce"),i=e("input[name=main_order_id]:checked",".wc-szamlazz-modal-grouped-generate-list").val();if(!i)return e(".wc-szamlazz-modal-grouped-generate-list").addClass("validate"),setTimeout(function(){e(".wc-szamlazz-modal-grouped-generate-list").removeClass("validate")},1e3),!1;t.loading_indicator(e(".wc-szamlazz-modal-grouped-generate-form"),"#fff");var s={action:t.prefix+"generate_grouped_invoice",nonce:n,orders:a,main_order:i};return e.post(ajaxurl,s,function(a){e(".wc-szamlazz-modal-grouped-generate-form").unblock(),o.show_messages(a,"grouped-generate-results"),a.data.error||(e(".wc-szamlazz-modal-grouped-generate-download").slideDown(),e(".wc-szamlazz-modal-grouped-generate-download-invoice").find("strong").text(a.data.name),e(".wc-szamlazz-modal-grouped-generate-download-invoice").attr("href",a.data.link),e(".wc-szamlazz-modal-grouped-generate-download-order").attr("href",a.data.order_link),e(".wc-szamlazz-modal-grouped-generate-form, .wc-szamlazz-modal-grouped-generate footer").slideUp())}),!1},show_messages:function(a,t){$messages=e(".wc-szamlazz-modal-"+t),a.data.messages&&a.data.messages.length>0&&($messages.removeClass("wc-szamlazz-metabox-messages-success"),$messages.removeClass("wc-szamlazz-metabox-messages-error"),a.data.error?$messages.addClass("wc-szamlazz-metabox-messages-error"):$messages.addClass("wc-szamlazz-metabox-messages-success"),$ul=$messages.find("ul"),$ul.html(""),e.each(a.data.messages,function(a,t){var o=e("<li>");o.append(t),$ul.append(o)}),$messages.slideDown())}};e("#wc_szamlazz_metabox").length&&t.init(),e("body.wc-szamlazz-settings").length&&a.init(),(e(".wc-szamlazz-bulk-actions").length||e("#tmpl-wc-szamlazz-modal-grouped-generate").length)&&o.init();var n={$menu_bar_item:e("#wp-admin-bar-wc-szamlazz-bg-generate-loading"),$link_stop:e("#wc-szamlazz-bg-generate-stop"),$link_refresh:e("#wc-szamlazz-bg-generate-refresh"),finished:!1,nonce:"",init:function(){this.$link_stop.on("click",this.stop),this.$link_refresh.on("click",this.reload_page),this.nonce=this.$link_stop.data("nonce");var e=this.refresh;setTimeout(e,5e3)},reload_page:function(){return location.reload(),!1},stop:function(){var a={action:"wc_szamlazz_bg_generate_stop",nonce:n.nonce};return e.post(ajaxurl,a,function(e){n.mark_stopped()}),!1},refresh:function(){var a={action:"wc_szamlazz_bg_generate_status",nonce:n.nonce};n.finished||e.post(ajaxurl,a,function(e){e.data.finished?n.mark_finished():setTimeout(n.refresh,5e3)})},mark_finished:function(){this.finished=!0,this.$menu_bar_item.addClass("finished")},mark_stopped:function(){this.mark_finished(),this.$menu_bar_item.addClass("stopped")}};e("#wp-admin-bar-wc-szamlazz-bg-generate-loading").length&&n.init();var i={needs_label:[],total_labels:0,labels_generated:0,document_type:["invoice"],init:function(){e("#wpbody").on("click","#doaction",function(){var a=e("#bulk-action-selector-top").val(),t=!1;if("wc_szamlazz_bulk_download_invoices"==a&&(t="download"),"wc_szamlazz_bulk_generate_documents"==a&&(t="generator"),"wc_szamlazz_bulk_generate_invoices"==a&&(t="generate"),t)return e("#the-list .check-column input:checked").length>0&&i.show_bulk_generate_modal({type:t}),!1}),e("body").on("change","#bulk-action-selector-top",function(){var a=!1,t=e("#bulk-action-selector-top").val();if("wc_szamlazz_bulk_download_invoices"==t&&(a="download"),"wc_szamlazz_bulk_generate_documents"==t&&(a="generator"),a)return e("#the-list .check-column input:checked").length>0&&i.show_bulk_generate_modal({type:a}),!1}),e("body").on("change",".wc-szamlazz-modal-generate-selectall",function(){var a=e(this).is(":checked");e('.wc-szamlazz-modal-generate table input[type="checkbox"]').attr("checked",a)}),e("body").on("wc_backbone_modal_removed",this.on_modal_close),e("body").on("click",".wc-szamlazz-modal-generate-button-download",this.download_in_bulk),e("body").on("click",".wc-szamlazz-modal-generate-button-print",this.print_in_bulk),e("body").on("click",".wc-szamlazz-modal-generate-document-print",this.print_single_label),e(document).on("change",'.wc-szamlazz-modal-generate-form input[name="bulk_invoice_type"]',this.toggle_bulk_generator_options),e(document).on("click",".wc-szamlazz-modal-generate-button-next",this.generate_labels),e(document).on("change",'.wc-szamlazz-modal-generate-download-type input[name="bulk_download_type"]',this.toggle_bulk_download_type)},show_bulk_generate_modal:function(a){var t=[];e("#the-list .check-column input:checked").each(function(){var a=e(this).parents("tr"),o=a.find(".wc-szamlazz-order-details").data("order-details");o.order_id&&(o.table_row=a,t.push(o))}),e(this).WCBackboneModal({template:"wc-szamlazz-modal-generate"});var o=e(".wc-szamlazz-modal-generate table");i.reset_modal_data(),i.total_labels=t.length,i.needs_label=[],t.forEach(function(a){var t=e("#wc_szamlazz_modal_generate_sample_row").html();(t=e(t)).find(".cell-order-number strong").text("#"+a.order_number),t.find(".cell-order-number span").text(a.customer_name),t.find(".cell-address span").text(a.billing_address),t.data("order-details",a),t.find("input").val(a.order_id),Object.keys(a.documents).length>0&&(Object.keys(a.documents).forEach(o=>{var n=e("<a>");n.text(a.documents[o].name),n.attr("href",a.documents[o].link),n.addClass("wc-szamlazz-modal-generate-document-"+o),n.attr("download",!0),t.find(".wc-szamlazz-modal-generate-documents").append(n)}),t.addClass("has-document")),o.find("tbody").append(t)});var n=e(".wc-szamlazz-modal-generate h1").data("titles");return e(".wc-szamlazz-modal-generate h1").html(n[a.type]),e(".wc-szamlazz-modal-generate").attr("data-type",a.type),"generate"==a.type&&(i.check_existing_documents(),i.generate_label()),"download"==a.type&&i.check_existing_documents(),i.update_counter(),i.type=a.type,!1},generate_label:function(){if(0==i.needs_label.length)return!1;var a=i.needs_label[0],t=a.data("order-details"),o={action:"wc_szamlazz_quick_generate_invoice",nonce:wc_szamlazz_params.nonces.generate,order:t.order_id,type:"invoice"};i.options&&i.options.type&&(o.type=i.options.type,o.deadline=i.options.deadline,o.completed=i.options.completed,o.account=i.options.account,o.note=i.options.note),e.post(ajaxurl,o,function(o){if(o.data.error)a.addClass("has-error"),a.find('input[type="checkbox"]').attr("disabled",!0);else{var n=e("<a>");n.text(o.data.name),n.attr("href",o.data.link),n.addClass("wc-szamlazz-modal-generate-document-"+o.data.type+" active"),n.attr("download",!0),a.find(".wc-szamlazz-modal-generate-document-"+o.data.type).remove(),a.find(".wc-szamlazz-modal-generate-documents").append(n),a.addClass("has-document");var s=t.table_row;if(o.data.order_status){var l=o.data.order_status.status;l=l.replace("wc-",""),s.find("td.order_status mark").removeClass(function(e,a){return(a.match(/(^|\s)status-\S+/g)||[]).join(" ")}).addClass("status-"+l),s.find("td.order_status span").text(o.data.order_status.name);var c=new URL(window.location.href),d=c.searchParams.get("status"),r=c.searchParams.get("post_status");if((d||r)&&(r||"all"!=d)){s.slideUp(),s.find(".check-column input").prop("checked",!1);var m=e("ul.subsubsub a.current").parent(),z=e("ul.subsubsub li."+o.data.order_status.status),_=parseInt(m.find(".count").text().replace(/[^0-9]/g,"")),u=parseInt(z.find(".count").text().replace(/[^0-9]/g,""));m.find(".count").text("("+(_-1)+")"),z.find(".count").text("("+(u+1)+")")}}var p=e('<a target="_blank">');p.attr("href",o.data.link),p.addClass("button tips wc-szamlazz-button wc-szamlazz-button-"+o.data.type),s.find("td.column-wc_szamlazz").append(p),t.parcel_number=o.data.number,t.download_link=o.data.pdf,t.documents[o.data.type]={name:o.data.name,link:o.data.link},s.find(".wc-szamlazz-order-details").data("order-details",t)}i.needs_label.shift(),i.generate_label(),i.update_counter()})},update_counter:function(){i.labels_generated=i.total_labels-i.needs_label.length;var a=e(".wc-szamlazz-modal-generate-progress-bar-text").data("labels");if(console.log(i.total_labels,i.needs_label.length),!a)return!1;var t=a.total.singular;i.total_labels>1&&(t=(t=a.total.plural).replace("%d",i.total_labels));var o=a.selected.singular;i.total_labels>1&&(o=(o=a.selected.plural).replace("%d",i.total_labels));var n=a.current.default;1==i.labels_generated&&(n=a.current.singular),i.labels_generated>1&&(n=(n=a.current.plural).replace("%d",i.labels_generated));var s=i.labels_generated/i.total_labels*100;e(".wc-szamlazz-modal-generate-progress-bar-inner").css("width",s+"%"),e(".wc-szamlazz-modal-generate-progress-bar-text-current").text(n),e(".wc-szamlazz-modal-generate-progress-bar-text-total").text(t),e(".wc-szamlazz-modal-generate-progress-bar-text-selected").text(o),0==i.needs_label.length&&(setTimeout(function(){e(".wc-szamlazz-modal-generate").addClass("done")},500),setTimeout(function(){e(".wc-szamlazz-modal-generate").removeClass("done"),e(".wc-szamlazz-modal-generate").addClass("finished")},500))},on_modal_close:function(e,a){"wc-szamlazz-modal-generate"==a&&i.reset_modal_data()},reset_modal_data:function(){e(".wc-szamlazz-modal-generate-table").find("tbody").html(""),e(".wc-szamlazz-modal-generate").removeClass("done"),e(".wc-szamlazz-modal-generate").removeClass("finished"),e(".wc-szamlazz-modal-generate").removeClass("generator"),i.needs_label=[],i.total_labels=0,i.labels_generated=0,i.type="generator",i.options={},i.document_type=["invoice"]},print_in_bulk:async function(){var a=e(this).parents("footer");a.block({message:null,overlayCSS:{background:"#fcfcfc url("+wc_szamlazz_params.loading+") no-repeat center",backgroundSize:"16px 16px",opacity:.6}});var t=i.generate_pdf_urls(),o=await i.merge_pdf_files(t),n=URL.createObjectURL(o);return printJS({printable:n,type:"pdf",onLoadingEnd:function(){a.unblock(),URL.revokeObjectURL(n)}}),!1},download_in_bulk:async function(){var e=i.generate_pdf_urls(),a=await i.merge_pdf_files(e);return saveAs(a,"merged.pdf"),!1},generate_pdf_urls:function(){var a=e(".wc-szamlazz-modal-generate table tr.has-document input:checked"),t=[];return e(a).each(function(o){e(a[o]).parents("tr").find(".wc-szamlazz-modal-generate-documents a.active").each(function(){var a=e(this).attr("href");t.push(a)})}),t},print_single_label:function(){var a=e(this).parent().find("a.active").attr("href");return a&&printJS(a),!1},merge_pdf_files:async function(e){console.log(e);const a=await PDFLib.PDFDocument.create(),t=e.length;for(var o=0;o<t;o++)try{const t=await fetch(e[o]).then(e=>e.arrayBuffer()),i=await PDFLib.PDFDocument.load(t);if(!i)continue;const s=i.getPageCount();for(var n=0;n<s;n++){const[e]=await a.copyPages(i,[n]);a.addPage(e)}}catch(e){console.log(e)}const i=await a.save();return new Blob([i],{type:"application/pdf"})},toggle_bulk_generator_options:function(){var a=e(this).val(),t=e(this).parent().text();e(".wc-szamlazz-modal-generate-table-document-type").text(t),i.document_type=[a],i.check_existing_documents(),"void"==a?e(".hidden-if-void").hide():e(".hidden-if-void").show()},generate_labels:function(){return i.options={account:e(".wc-szamlazz-modal-generate #wc_szamlazz_bulk_invoice_account").val(),type:e('.wc-szamlazz-modal-generate input[name="bulk_invoice_type"]:checked').val(),note:e(".wc-szamlazz-modal-generate #wc_szamlazz_bulk_invoice_note").val(),deadline:e(".wc-szamlazz-modal-generate #wc_szamlazz_bulk_invoice_deadline").val(),completed:e(".wc-szamlazz-modal-generate #wc_szamlazz_bulk_invoice_completed").val()},i.document_type=[i.options.type],i.check_existing_documents(),e(".wc-szamlazz-modal-generate").attr("data-type","generate"),e(".wc-szamlazz-modal-generate").removeClass("finished"),i.generate_label(),i.update_counter(),!1},check_existing_documents:function(){var a=i.document_type;i.needs_label=[],e(".wc-szamlazz-modal-generate-table tbody tr").each(function(){var t=e(this),o=t.data("order-details");t.removeClass("has-document"),t.find(".wc-szamlazz-modal-generate-documents a").removeClass("active"),a.forEach(function(e){o.documents[e]?(t.addClass("has-document"),t.attr("data-type",e),t.find(".wc-szamlazz-modal-generate-document-"+e).addClass("active"),console.log(".wc-szamlazz-modal-generate-document-"+e)):i.needs_label.push(t)})}),i.labels_generated=i.total_labels-i.needs_label.length},toggle_bulk_download_type:function(){var a=e(this).parents(".wc-szamlazz-modal-generate-download-type").find("input:checked").map(function(){return e(this).val()}).get();i.document_type=a,i.check_existing_documents()}};e(".wc-szamlazz-order-details").length&&i.init()});